name: Release Alpha

on:
  workflow_dispatch:
  push:
    branches:
      - alpha

permissions:
  contents: read

jobs:
  release:
    permissions:
      contents: write
      packages: write
      id-token: write
      issues: write
    name: Perform Alpha Release
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.setup.outputs.node-version }}
      release-version: ${{ steps.version.outputs.release-version }}
      release-channel: alpha
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Environment
        id: setup
        uses: ./.github/actions/setup-node

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint
      - name: Test
        run: pnpm run test
      - name: Calculate Next Alpha Version
        id: version
        run: |
          # Get latest alpha tag (only 2.1.0-alpha.X pattern)
          LATEST_ALPHA=$(git tag -l "v2.1.0-alpha.*" --sort=-v:refname | head -n1)
          echo "Latest alpha tag: $LATEST_ALPHA"
          
          if [ -z "$LATEST_ALPHA" ]; then
            # No alpha tag exists, start with alpha.1
            NEXT_VERSION="2.1.0-alpha.1"
          else
            # Parse existing alpha version and increment only the alpha number
            ALPHA_NUM=${LATEST_ALPHA##*-alpha.}
            NEXT_VERSION="2.1.0-alpha.$((ALPHA_NUM + 1))"
          fi
          
          echo "Next version: $NEXT_VERSION"
          echo "release-version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Update Package Versions
        run: |
          VERSION="${{ steps.version.outputs.release-version }}"
          pnpm run release:version "$VERSION"

      - name: Build with Version
        run: pnpm run build
        env:
          BASE_URL: /home-assistant-matter-hub
          APP_VERSION: ${{ steps.version.outputs.release-version }}

      - name: Package
        run: pnpm run release:pack

      - name: Create Git Tag
        run: |
          VERSION="${{ steps.version.outputs.release-version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.release-version }}"
          # Get commits since last alpha tag
          LATEST_ALPHA=$(git tag -l "v2.1.0-alpha.*" --sort=-v:refname | grep -v "v$VERSION" | head -n1)
          
          if [ -n "$LATEST_ALPHA" ]; then
            echo "Generating changelog from $LATEST_ALPHA to HEAD"
            COMMITS=$(git log --pretty=format:"- %s (%h)" "$LATEST_ALPHA"..HEAD^ 2>/dev/null || git log --pretty=format:"- %s (%h)" -10)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" -10)
          fi
          
          # Create CHANGELOG.md
          {
            echo "# v$VERSION"
            echo ""
            echo "## Changes"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "---"
            echo "⚠️ **This is an alpha release** - use at your own risk!"
          } > CHANGELOG.md
          
          # Create CHANGELOG_FULL.md (same content for alpha)
          cp CHANGELOG.md CHANGELOG_FULL.md
          
          # Store for release notes
          {
            echo "CHANGELOG<<EOF"
            echo "$COMMITS"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.release-version }}"
          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --notes-file CHANGELOG.md \
            --prerelease \
            CHANGELOG_FULL.md

      - name: Package Artifact
        uses: actions/upload-artifact@v5
        with:
          name: package.tgz
          path: apps/home-assistant-matter-hub/package.tgz

  prepare-docker:
    name: "Prepare Docker"
    runs-on: ubuntu-latest
    outputs:
      dockerfiles: ${{ steps.dockerfiles.outputs.dockerfiles }}
    steps:
      - uses: actions/checkout@v6
      - name: Find Dockerfiles
        id: dockerfiles
        uses: ./.github/actions/find-dockerfiles

  docker:
    name: "Build Docker"
    runs-on: ubuntu-24.04-arm
    needs: [prepare-docker, release]
    if: needs.release.outputs.release-version != ''
    permissions:
      packages: write
    strategy:
      matrix:
        dockerfile: ${{ fromJSON(needs.prepare-docker.outputs.dockerfiles) }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Docker
        uses: ./.github/actions/setup-docker

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package Artifact
        uses: actions/download-artifact@v6
        with:
          name: package.tgz
          path: apps/home-assistant-matter-hub/
          merge-multiple: true

      - name: Build Docker
        uses: ./.github/actions/docker
        with:
          push: true
          channel: alpha
          dockerfile: ${{ matrix.dockerfile }}
          node-version: ${{ needs.release.outputs.node-version }}
          package-version: ${{ needs.release.outputs.release-version }}

  dispatch-addon:
    name: "Dispatch Addon Repository"
    runs-on: ubuntu-latest
    needs: [release, docker]
    if: needs.release.outputs.release-version != ''
    steps:
      - name: Dispatch Addon Repository
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.ADDON_REPOSITORY_PAT }}
          repository: "riddix/home-assistant-addons"
          event-type: release
          client-payload: |
            {
              "project": "hamh",
              "channel": "alpha",
              "version": "${{needs.release.outputs.release-version}}",
              "changelogUrl": "https://github.com/${{github.repository}}/releases/download/v${{needs.release.outputs.release-version}}/CHANGELOG_FULL.md"
            }
