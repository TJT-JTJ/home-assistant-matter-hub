name: Release Alpha

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'alpha'
        type: choice
        options:
          - alpha    # Only increment alpha counter (2.1.0-alpha.1 -> 2.1.0-alpha.2)
          - patch    # Increment patch and reset alpha (2.1.0-alpha.x -> 2.1.1-alpha.1)
          - minor    # Increment minor and reset alpha (2.1.0-alpha.x -> 2.2.0-alpha.1)
  push:
    branches:
      - alpha

permissions:
  contents: read

jobs:
  release:
    permissions:
      contents: write
      packages: write
      id-token: write
      issues: write
    name: Perform Alpha Release
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.setup.outputs.node-version }}
      release-version: ${{ steps.version.outputs.release-version }}
      release-channel: alpha
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Environment
        id: setup
        uses: ./.github/actions/setup-node

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint
      - name: Test
        run: pnpm run test
      - name: Build
        run: pnpm run build
        env:
          BASE_URL: /home-assistant-matter-hub

      - name: Calculate Next Version
        id: version
        run: |
          # Get latest alpha tag
          LATEST_ALPHA=$(git tag -l "v*-alpha.*" --sort=-v:refname | head -n1)
          echo "Latest alpha tag: $LATEST_ALPHA"
          
          if [ -z "$LATEST_ALPHA" ]; then
            # No alpha tag exists, start from main's latest + minor bump
            LATEST_MAIN=$(git tag -l "v[0-9]*.[0-9]*.[0-9]" --sort=-v:refname | grep -v alpha | grep -v testing | head -n1)
            echo "Latest main tag: $LATEST_MAIN"
            if [ -z "$LATEST_MAIN" ]; then
              NEXT_VERSION="2.1.0-alpha.1"
            else
              # Extract version numbers
              VERSION=${LATEST_MAIN#v}
              IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
              NEXT_VERSION="${MAJOR}.$((MINOR + 1)).0-alpha.1"
            fi
          else
            # Parse existing alpha version
            VERSION=${LATEST_ALPHA#v}
            BASE_VERSION=${VERSION%-alpha.*}
            ALPHA_NUM=${VERSION##*-alpha.}
            
            IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"
            
            BUMP_TYPE="${{ github.event.inputs.bump }}"
            if [ -z "$BUMP_TYPE" ]; then
              BUMP_TYPE="alpha"
            fi
            
            case "$BUMP_TYPE" in
              alpha)
                NEXT_VERSION="${BASE_VERSION}-alpha.$((ALPHA_NUM + 1))"
                ;;
              patch)
                NEXT_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))-alpha.1"
                ;;
              minor)
                NEXT_VERSION="${MAJOR}.$((MINOR + 1)).0-alpha.1"
                ;;
            esac
          fi
          
          echo "Next version: $NEXT_VERSION"
          echo "release-version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Update Package Versions
        run: |
          VERSION="${{ steps.version.outputs.release-version }}"
          pnpm run release:version "$VERSION"

      - name: Rebuild with New Version
        run: pnpm run build
        env:
          BASE_URL: /home-assistant-matter-hub

      - name: Package
        run: pnpm run release:pack

      - name: Create Git Tag
        run: |
          VERSION="${{ steps.version.outputs.release-version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.release-version }}"
          # Get commits since last alpha tag
          LATEST_ALPHA=$(git tag -l "v*-alpha.*" --sort=-v:refname | grep -v "v$VERSION" | head -n1)
          if [ -n "$LATEST_ALPHA" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" "$LATEST_ALPHA"..HEAD~1)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" -10)
          fi
          
          # Create CHANGELOG.md file for release asset
          echo "# v$VERSION" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Changes" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "$COMMITS" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "⚠️ **This is an alpha release** - use at your own risk!" >> CHANGELOG.md
          
          # Create CHANGELOG_FULL.md (same content for alpha)
          cp CHANGELOG.md CHANGELOG_FULL.md
          
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.release-version }}"
          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --notes "## Alpha Release v$VERSION

          ${{ env.CHANGELOG }}

          ---
          ⚠️ **This is an alpha release** - use at your own risk!
          " \
            --prerelease \
            CHANGELOG.md \
            CHANGELOG_FULL.md

      - name: Package Artifact
        uses: actions/upload-artifact@v5
        with:
          name: package.tgz
          path: apps/home-assistant-matter-hub/package.tgz

  prepare-docker:
    name: "Prepare Docker"
    runs-on: ubuntu-latest
    outputs:
      dockerfiles: ${{ steps.dockerfiles.outputs.dockerfiles }}
    steps:
      - uses: actions/checkout@v6
      - name: Find Dockerfiles
        id: dockerfiles
        uses: ./.github/actions/find-dockerfiles

  docker:
    name: "Build Docker"
    runs-on: ubuntu-24.04-arm
    needs: [prepare-docker, release]
    if: needs.release.outputs.release-version != ''
    permissions:
      packages: write
    strategy:
      matrix:
        dockerfile: ${{ fromJSON(needs.prepare-docker.outputs.dockerfiles) }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Docker
        uses: ./.github/actions/setup-docker

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package Artifact
        uses: actions/download-artifact@v6
        with:
          name: package.tgz
          path: apps/home-assistant-matter-hub/
          merge-multiple: true

      - name: Build Docker
        uses: ./.github/actions/docker
        with:
          push: true
          channel: alpha
          dockerfile: ${{ matrix.dockerfile }}
          node-version: ${{ needs.release.outputs.node-version }}
          package-version: ${{ needs.release.outputs.release-version }}

  dispatch-addon:
    name: "Dispatch Addon Repository"
    runs-on: ubuntu-latest
    needs: [release, docker]
    if: needs.release.outputs.release-version != ''
    steps:
      - name: Dispatch Addon Repository
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.ADDON_REPOSITORY_PAT }}
          repository: "riddix/home-assistant-addons"
          event-type: release
          client-payload: |
            {
              "project": "hamh",
              "channel": "alpha",
              "version": "${{needs.release.outputs.release-version}}",
              "changelogUrl": "https://github.com/${{github.repository}}/releases/tag/v${{needs.release.outputs.release-version}}"
            }
