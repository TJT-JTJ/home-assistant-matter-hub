name: Release Alpha

on:
  workflow_dispatch:
  push:
    branches:
      - alpha

permissions:
  contents: read

jobs:
  release:
    permissions:
      contents: write
      packages: write
      id-token: write
      issues: write
    name: Perform Alpha Release
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.setup.outputs.node-version }}
      release-version: ${{ steps.release.outputs.release-version }}
      release-channel: alpha
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Environment
        id: setup
        uses: ./.github/actions/setup-node

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint
      - name: Test
        run: pnpm run test
      - name: Build
        run: pnpm run build
        env:
          BASE_URL: /home-assistant-matter-hub

      - name: Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm run release

      - name: Analyze Release
        id: release
        run: |
          RELEASE_VERSION=$([ -f RELEASE_VERSION ] && cat RELEASE_VERSION || echo '')
          RELEASE_CHANNEL=$([ -f RELEASE_CHANNEL ] && cat RELEASE_CHANNEL || echo 'alpha')
          echo "release-version=$RELEASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "release-channel=$RELEASE_CHANNEL" >> "$GITHUB_OUTPUT"
          cat "$GITHUB_OUTPUT"

      - name: Package Artifact
        uses: actions/upload-artifact@v5
        with:
          name: package.tgz
          path: apps/home-assistant-matter-hub/package.tgz

  prepare-docker:
    name: "Prepare Docker"
    runs-on: ubuntu-latest
    outputs:
      dockerfiles: ${{ steps.dockerfiles.outputs.dockerfiles }}
    steps:
      - uses: actions/checkout@v6
      - name: Find Dockerfiles
        id: dockerfiles
        uses: ./.github/actions/find-dockerfiles

  docker:
    name: "Build Docker"
    runs-on: ubuntu-24.04-arm
    needs: [prepare-docker, release]
    if: needs.release.outputs.release-version != ''
    permissions:
      packages: write
    strategy:
      matrix:
        dockerfile: ${{ fromJSON(needs.prepare-docker.outputs.dockerfiles) }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Docker
        uses: ./.github/actions/setup-docker

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package Artifact
        uses: actions/download-artifact@v6
        with:
          name: package.tgz
          path: apps/home-assistant-matter-hub/
          merge-multiple: true

      - name: Build Docker
        uses: ./.github/actions/docker
        with:
          push: true
          channel: alpha
          dockerfile: ${{ matrix.dockerfile }}
          node-version: ${{ needs.release.outputs.node-version }}
          package-version: ${{ needs.release.outputs.release-version }}

  dispatch-addon:
    name: "Dispatch Addon Repository"
    runs-on: ubuntu-latest
    needs: [release, docker]
    if: needs.release.outputs.release-version != ''
    steps:
      - name: Dispatch Addon Repository
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.ADDON_REPOSITORY_PAT }}
          repository: "riddix/home-assistant-addons"
          event-type: release
          client-payload: |
            {
              "project": "hamh",
              "channel": "alpha",
              "version": "${{needs.release.outputs.release-version}}",
              "changelogUrl": "https://github.com/${{github.repository}}/releases/download/v${{needs.release.outputs.release-version}}/CHANGELOG_FULL.md"
            }
